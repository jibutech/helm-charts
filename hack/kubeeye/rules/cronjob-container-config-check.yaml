apiVersion: kubeeye.kubesphere.io/v1alpha2
kind: InspectRule
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"kubeeye.kubesphere.io/v1alpha2","kind":"InspectRule","metadata":{"annotations":{},"labels":{"inspection.jibudata.com/rule-category":"Container"},"name":"cronjob-container-config-check"},"spec":{"opas":[{"name":"imagePullPolicyRuleForCronJob","rule":"package inspect.kubeeye\nimport rego.v1\n\ndeny contains msg if {\n\n  input.kind == \"CronJob\"\n  input.apiVersion == \"batch/v1\"\n  \n  level := \"WARNING\"\n\n  container := input.spec.jobTemplate.spec.template.spec.containers[_]\n  policy := container.imagePullPolicy\n  policy != \"IfNotPresent\"\n\n  msg := {\n      \"Name\": sprintf(\"%v\", [input.metadata.name]),\n      \"Namespace\": sprintf(\"%v\", [input.metadata.namespace]),\n      \"Type\": sprintf(\"%v\", [input.kind]),\n      \"Message\": \"CronJob镜像拉取策略规则\",\n      \"Reason\": sprintf(\"当前资源镜像拉取策略为: %v , 需要修改为 IfNotPresent \", [policy]),\n      \"Level\": sprintf(\"%v\", [level])\n  }\n}"},{"name":"imageTagLatestRuleForCronJob","rule":"package inspect.kubeeye\nimport rego.v1\n\ndeny contains msg if {\n\n  input.kind == \"CronJob\"\n  input.apiVersion == \"batch/v1\"\n  \n  level := \"WARNING\"\n\n  container := input.spec.jobTemplate.spec.template.spec.containers[_]\n  \n  # 检查镜像是否使用 latest 标签（没有指定标签）\n  image_parts := split(container.image, \":\")\n  count(image_parts) == 1  # 没有指定标签，默认为 latest\n\n  msg := {\n      \"Name\": sprintf(\"%v\", [input.metadata.name]),\n      \"Namespace\": sprintf(\"%v\", [input.metadata.namespace]),\n      \"Type\": sprintf(\"%v\", [input.kind]),\n      \"Message\": \"CronJob 镜像标签检查规则\",\n      \"Reason\": sprintf(\"容器 %v 使用的镜像 %v 没有指定版本标签，将使用 latest 标签，建议指定明确的版本号\", [container.name, container.image]),\n      \"Level\": sprintf(\"%v\", [level])\n  }\n}\n\ndeny contains msg if {\n\n  input.kind == \"CronJob\"\n  input.apiVersion == \"batch/v1\"\n  \n  level := \"WARNING\"\n\n  container := input.spec.jobTemplate.spec.template.spec.containers[_]\n  \n  # 检查镜像是否明确使用 latest 标签\n  image_parts := split(container.image, \":\")\n  count(image_parts) \u003e= 2\n  image_parts[1] == \"latest\"\n\n  msg := {\n      \"Name\": sprintf(\"%v\", [input.metadata.name]),\n      \"Namespace\": sprintf(\"%v\", [input.metadata.namespace]),\n      \"Type\": sprintf(\"%v\", [input.kind]),\n      \"Message\": \"CronJob 镜像标签检查规则\",\n      \"Reason\": sprintf(\"容器 %v 使用的镜像 %v 明确指定了 latest 标签，建议使用具体的版本号\", [container.name, container.image]),\n      \"Level\": sprintf(\"%v\", [level])\n  }\n}"}]}}
  creationTimestamp: "2025-06-20T02:50:28Z"
  finalizers:
  - kubeeye.finalizers.kubesphere.io
  generation: 1
  labels:
    inspection.jibudata.com/rule-category: Container
  name: cronjob-container-config-check
  resourceVersion: "2917386"
  uid: 69886a0a-9503-4d6b-ae52-1a64aefe8788
spec:
  opas:
  - name: imagePullPolicyRuleForCronJob
    rule: "package inspect.kubeeye\nimport rego.v1\n\ndeny contains msg if {\n\n  input.kind
      == \"CronJob\"\n  input.apiVersion == \"batch/v1\"\n  \n  level := \"WARNING\"\n\n
      \ container := input.spec.jobTemplate.spec.template.spec.containers[_]\n  policy
      := container.imagePullPolicy\n  policy != \"IfNotPresent\"\n\n  msg := {\n      \"Name\":
      sprintf(\"%v\", [input.metadata.name]),\n      \"Namespace\": sprintf(\"%v\",
      [input.metadata.namespace]),\n      \"Type\": sprintf(\"%v\", [input.kind]),\n
      \     \"Message\": \"CronJob镜像拉取策略规则\",\n      \"Reason\": sprintf(\"当前资源镜像拉取策略为:
      %v , 需要修改为 IfNotPresent \", [policy]),\n      \"Level\": sprintf(\"%v\", [level])\n
      \ }\n}"
  - name: imageTagLatestRuleForCronJob
    rule: "package inspect.kubeeye\nimport rego.v1\n\ndeny contains msg if {\n\n  input.kind
      == \"CronJob\"\n  input.apiVersion == \"batch/v1\"\n  \n  level := \"WARNING\"\n\n
      \ container := input.spec.jobTemplate.spec.template.spec.containers[_]\n  \n
      \ # 检查镜像是否使用 latest 标签（没有指定标签）\n  image_parts := split(container.image, \":\")\n
      \ count(image_parts) == 1  # 没有指定标签，默认为 latest\n\n  msg := {\n      \"Name\":
      sprintf(\"%v\", [input.metadata.name]),\n      \"Namespace\": sprintf(\"%v\",
      [input.metadata.namespace]),\n      \"Type\": sprintf(\"%v\", [input.kind]),\n
      \     \"Message\": \"CronJob 镜像标签检查规则\",\n      \"Reason\": sprintf(\"容器 %v
      使用的镜像 %v 没有指定版本标签，将使用 latest 标签，建议指定明确的版本号\", [container.name, container.image]),\n
      \     \"Level\": sprintf(\"%v\", [level])\n  }\n}\n\ndeny contains msg if {\n\n
      \ input.kind == \"CronJob\"\n  input.apiVersion == \"batch/v1\"\n  \n  level
      := \"WARNING\"\n\n  container := input.spec.jobTemplate.spec.template.spec.containers[_]\n
      \ \n  # 检查镜像是否明确使用 latest 标签\n  image_parts := split(container.image, \":\")\n
      \ count(image_parts) >= 2\n  image_parts[1] == \"latest\"\n\n  msg := {\n      \"Name\":
      sprintf(\"%v\", [input.metadata.name]),\n      \"Namespace\": sprintf(\"%v\",
      [input.metadata.namespace]),\n      \"Type\": sprintf(\"%v\", [input.kind]),\n
      \     \"Message\": \"CronJob 镜像标签检查规则\",\n      \"Reason\": sprintf(\"容器 %v
      使用的镜像 %v 明确指定了 latest 标签，建议使用具体的版本号\", [container.name, container.image]),\n
      \     \"Level\": sprintf(\"%v\", [level])\n  }\n}"
status:
  endImportTime: "2025-06-20T05:22:25Z"
  levelCount:
    warning: 2
  startImportTime: "2025-06-20T05:22:24Z"
  state: ImportComplete
